# Database Migrations with Alembic

This document explains how database migrations are managed in the Pulse AI project using Alembic.

**Note**: A demonstration script is available at [`/test_migration.py`](/test_migration.py) that shows the full migration workflow in action. This interactive example is an excellent starting point for developers new to Alembic.

## Overview

We use Alembic to track and apply database schema changes in a controlled, versioned manner. This allows us to:

1. Track all schema changes in version control
2. Apply changes incrementally
3. Roll back to previous schema versions if needed
4. Support collaborative development without schema conflicts
5. Maintain consistency between development and production environments

## Migration Structure

The migration system is set up in the following directory structure:

```
pulse-ai/
├── alembic.ini          # Alembic configuration file
├── migrations/          # Migration scripts directory
│   ├── README           # Documentation for migrations
│   ├── env.py           # Environment configuration
│   ├── script.py.mako   # Template for migration scripts
│   └── versions/        # Version-specific migration scripts
│       ├── 1e9e89fe38af_initial_database_schema.py
│       └── ...
```

## How to Use

### Creating a New Migration

When you make changes to the database models (in `db/models.py`), you need to create a migration script to apply those changes to the database:

```bash
cd /path/to/pulse-ai
source venv/bin/activate
alembic revision --autogenerate -m "Description of your changes"
```

This will generate a new migration script in the `migrations/versions/` directory.

### Applying Migrations

To apply all pending migrations to bring the database up to date:

```bash
alembic upgrade head
```

To apply migrations incrementally (one at a time):

```bash
alembic upgrade +1
```

### Reverting Migrations

To revert the most recent migration:

```bash
alembic downgrade -1
```

To revert to a specific migration:

```bash
alembic downgrade <revision_id>
```

To revert all migrations:

```bash
alembic downgrade base
```

### Checking Migration Status

To see the current database version:

```bash
alembic current
```

To see the migration history:

```bash
alembic history
```

## Best Practices

1. **Review Autogenerated Migrations**: Always review and test autogenerated migration scripts before applying them
2. **Test Both Directions**: Ensure both `upgrade()` and `downgrade()` functions work correctly
3. **One Change per Migration**: Keep migrations focused on a single logical change when possible
4. **Don't Modify Existing Migrations**: Once a migration is committed, create a new one for additional changes
5. **Handle Data Changes Carefully**: Include data migrations alongside schema changes when necessary
6. **Test on Sample Data**: Test migrations on a copy of the production database if possible

## Common Issues and Solutions

### Circular Dependencies

SQLAlchemy models with circular references can cause issues with Alembic autogeneration. Our solution:

1. Create tables in the correct order (parent tables first)
2. Handle circular foreign keys with deferred constraints or by adding them separately

### Large Migrations

Large, complex migrations can be difficult to roll back. Strategies:

1. Break them into smaller, incremental migrations
2. Include data validation in critical migrations
3. Consider using transactions for atomic changes

### Schema Drift

When the actual database schema differs from what Alembic expects:

1. Use `alembic stamp <revision>` to mark a revision as complete without running it
2. Create a new migration from the current state
3. Use manual interventions for complex reconciliation

## Migration Review Process

Before merging migration changes:

1. Run the full migration sequence on a test database
2. Verify that the application works with the new schema
3. Test downgrade paths if relevant
4. Check for any potential performance impacts

## Example Migration Workflow

1. Modify models in `db/models.py`
2. Generate migration: `alembic revision --autogenerate -m "Add user preferences"`
3. Review and edit the generated migration script
4. Apply migration: `alembic upgrade head`
5. Test application functionality
6. Commit both model changes and migration script